var Lastfm=Class.create({initialize:function(extra){this.settings={username:"thinkphp",where:"result",badgeid:"badge",badgeclass:"lastfm",amount:10};if(extra){Object.extend(this.settings,extra)}this.tpl="<li><a href='#{link}'>#{title}</a> <div>#{pubDate}</div></li>";this.badgeid=this.settings.badgeid+(+new Date().getTime());this._callData()},_callData:function(){var user=this.settings.username,proxy="proxy.php";new Ajax.Request(proxy,{method:"get",parameters:{user:user},requestHeaders:{Accept:"application/json"},onSuccess:function(transport){this._retrieveData(transport.responseText.evalJSON(true))}.bind(this)})},_retrieveData:function(dataset){if(dataset.query.results!==null){this._displayData(dataset)}else{this._handleError()}},_displayData:function(dataset){var out=$(this.settings.where),items=dataset.query.results.item,n=items.length,output="",ul=new Element("ul",{id:this.badgeid,"class":this.settings.badgeclass}),myTemplate=new Template(this.tpl);for(var i=0;i<n;i++){output+=myTemplate.evaluate(items[i])}ul.innerHTML=output;out.appendChild(ul);$$("#"+this.settings.where+" a")[0].focus()},_handleError:function(){$(this.settings.where).set("html","<span><b>User Not Found</b></span>")}});Element.addMethods({lastfm:function(element,opts){var where=element.id,username=opts.username;new Lastfm({username:username,where:where})}});